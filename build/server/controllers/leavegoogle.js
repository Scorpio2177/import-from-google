// Generated by CoffeeScript 1.9.3
var async, cozydb, googleToken, importCalendar, importContacts, importPhotos, log, realtimer, syncGmail;

async = require('async');

cozydb = require('cozydb');

googleToken = require('../utils/google_access_token');

importCalendar = require('../utils/import_calendar');

importContacts = require('../utils/import_contacts');

importPhotos = require('../utils/import_photos');

log = require('printit')({
  date: true,
  prefix: 'leave'
});

realtimer = require('../utils/realtimer');

syncGmail = require('../utils/sync_gmail');

module.exports.index = function(req, res) {
  var url;
  url = googleToken.getAuthUrl();
  return cozydb.api.getCozyLocale(function(err, locale) {
    if (err) {
      log.error(err);
    }
    return res.render('index', {
      imports: "window.oauthUrl = \"" + url + "\";\nwindow.locale = \"" + (locale || 'en') + "\";"
    });
  });
};

module.exports.lg = function(req, res, next) {
  var auth_code, ref, scope;
  res.sendStatus(200);
  ref = req.body, auth_code = ref.auth_code, scope = ref.scope;
  return googleToken.generateRequestToken(auth_code, function(err, tokens) {
    if (err) {
      log.error(err);
    }
    if (!(tokens != null ? tokens.access_token : void 0)) {
      log.info("No access token");
      realtimer.sendEnd("invalid token");
      return;
    }
    return async.series([
      function(callback) {
        log.info("## Getting tokens");
        return syncGmail(tokens.access_token, tokens.refresh_token, scope.sync_gmail === 'true', function(err) {
          if (err) {
            log.error(err);
          }
          if (scope.sync_gmail === 'true') {
            realtimer.sendEnd("syncGmail.end");
          }
          return callback(null);
        });
      }, function(callback) {
        if (scope.photos !== 'true') {
          return callback(null);
        }
        log.info("## Start import of photos");
        return importPhotos(tokens.access_token, function(err) {
          if (err) {
            realtimer.sendPhotosErr(err);
          }
          realtimer.sendEnd("photos.end");
          return callback(null);
        });
      }, function(callback) {
        if (scope.calendars !== 'true') {
          return callback(null);
        }
        log.info("## Start import of events");
        return importCalendar(tokens.access_token, function(err) {
          if (err) {
            realtimer.sendCalendarErr(err);
          }
          realtimer.sendEnd("events.end");
          return callback(null);
        });
      }, function(callback) {
        if (scope.contacts !== 'true') {
          return callback(null);
        }
        log.info("## Start import of contacts");
        return importContacts(tokens.access_token, function(err) {
          if (err) {
            realtimer.sendContactsErr(err);
          }
          realtimer.sendEnd("contacts.end");
          return callback(null);
        });
      }
    ], function(err) {
      log.info("import from google complete");
      realtimer.sendEnd("ok");
      if (err) {
        return log.raw(err);
      }
    });
  });
};

module.exports.logClient = function(req, res) {
  var ref;
  log.error(req.body.data);
  log.error((ref = req.body.data.error) != null ? ref.stack : void 0);
  return res.send('ok');
};
